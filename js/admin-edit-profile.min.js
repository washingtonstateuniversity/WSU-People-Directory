var wsuwp=wsuwp||{};!function(u,c,h,f){u(h).ready(function(){var o,t,e=u("#load-ad-data"),s=u("#publishing-action .spinner"),n=u("#_wsuwp_profile_ad_nid"),i=u("#confirm-ad-hash"),r=u("#confirm-ad-data"),a=u(".wsu-person .card"),l=u(".wsu-person-photo-collection"),p=_.template(u(".wsu-person-repeatable-meta-template").html()),d=_.template(u(".wsu-person-photo-template").html());u(".card header").append("<button type='button' data-type='degree' class='wsu-person-add-repeatable-meta wsu-person-add-degree'>+ Add</button>"),u(".contact .title").last().after("\n<button type='button' data-type='title' class='wsu-person-add-repeatable-meta wsu-person-add-title'>+ Add another title</button>"),u.each(u(".contact .title").slice(1),function(){u(this).after("<button type='button' class='wsu-person-remove dashicons dashicons-no'><span class='screen-reader-text'>Delete</span></button>")}),u.each(u("header .degree"),function(){u(this).after("<button type='button' class='wsu-person-remove dashicons dashicons-no'><span class='screen-reader-text'>Delete</span></button>")}),e.on("click",function(t){if(t.preventDefault(),t.target.disabled=!0,""!==n.val()){s.css("visibility","visible");var e={action:"wsu_people_get_data_by_nid",_ajax_nonce:c.wsuwp_people_edit_profile.nid_nonce,network_id:n.val(),request_from:c.wsuwp_people_edit_profile.request_from};u.post(c.ajaxurl,e,function(e){t.target.disabled=!1,s.css("visibility","hidden"),e.success?u.isEmptyObject(e.data)?c.alert("Sorry, a profile for "+n.val()+" could not be found."):(e.data.id?f.people.populate_person_from_people_directory(e.data):(u(".wsu-person").attr("data-nid",n.val()),u(".wsu-person .name").text(e.data.given_name+" "+e.data.surname),u("[name='post_title']").val(e.data.given_name+" "+e.data.surname),u(".wsu-person .title").text(e.data.title),u("[name='_wsuwp_profile_title[]']").val(e.data.title),u(".wsu-person .email").text(e.data.email),u("[name='_wsuwp_profile_alt_email']").val(e.data.email),u(".wsu-person .phone").text(e.data.telephone_number),u("[name='_wsuwp_profile_alt_phone']").val(e.data.telephone_number),u(".wsu-person .office").text(e.data.office),u("[name='_wsuwp_profile_alt_office']").val(e.data.office),u(".wsu-person .address").text(e.data.street_address),u("[name='_wsuwp_profile_alt_address']").val(e.data.street_address),i.val(e.data.confirm_ad_hash)),u("#wsuwp-university-taxonomies").addClass("show"),u("#wsuwp-profile-listing").addClass("show"),u("#wsuwp-profile-local-display").addClass("show"),r.removeClass("profile-hide-button")):c.alert(e.data)})}else c.alert("Please enter a Network ID")}),r.on("click",function(e){e.preventDefault(),e.target.disabled=!0,s.css("visibility","visible"),u("#load-ad-data").addClass("profile-hide-button");var t={action:"wsu_people_confirm_nid_data",_ajax_nonce:c.wsuwp_people_edit_profile.nid_nonce,network_id:n.val(),confirm_ad_hash:i.val(),post_id:u("#post_ID").val(),request_from:c.wsuwp_people_edit_profile.request_from},o=u(".load-ad-container .description"),a=u("#publish");u.post(c.ajaxurl,t,function(e){e.success&&(n.attr("readonly",!0),o.html("The WSU Network ID used to populate this profile's data from "+o.data("location")+"."),u(".spinner").css("visibility","hidden"),r.addClass("profile-hide-button"),a.removeClass("profile-hide-button"))})}),a.on("focusout","[contenteditable='true']",function(){var e=u(this).attr("class"),t=u(this).index("."+e),o=u(this).text();u("[data-for='"+e+"']").eq(t).val(o)}),a.on("keypress","[contenteditable='true']",function(e){13===e.which&&e.preventDefault()}),a.on("click",".wsu-person-add-repeatable-meta",function(){u(this).before(p({type:u(this).data("type"),value:""}))}),a.on("focus",".title, .degree",function(){u(this).next("button:not(.wsu-person-add-repeatable-meta)").show(50)}),a.on("focusout",".title, .degree, .wsu-person-remove",function(e){var t=u(e.relatedTarget);if(!t.hasClass("wsu-person-remove"))if(t.hasClass("title")||t.hasClass("title")){var o=t.next(".wsu-person-remove").index(".wsu-person-remove");u(".wsu-person-remove").not(":eq("+o+")").hide(50)}else u(".wsu-person-remove").hide(50)}),a.on("click",".wsu-person-remove",function(){var e=u(this).prev("span"),t=e.attr("class"),o=e.index("."+t);e.remove(),u("[data-for='"+t+"']").eq(o).remove(),u(this).remove()}),a.on("click",".photo",function(){if(!u(this).hasClass("wsu-person-add-photo")){var e=u(this).offset();o=h.activeElement,u(c).scrollTop(0),u("body").addClass("wsu-person-photo-collection-open"),l.css({top:e.top,left:e.left}),u(".wsu-person-add-photo").focus()}}),u(h).keydown(function(e){if(u("body").hasClass("wsu-person-photo-collection-open")){if(9===e.which){var t=l.find("button"),o=t.index(u(":focus"));e.shiftKey&&0===o?(t[t.length-1].focus(),e.preventDefault()):event.shiftKey||o!==t.length-1||(t[0].focus(),e.preventDefault())}27===e.which&&f.close_photo_collection()}}),u(h).on("click",".wsu-person-photo-collection-close",function(e){e.target===this&&f.close_photo_collection()}),u(h).on("click",".wsu-person-add-photo",function(){t||(t=c.wp.media({title:"Select or Upload Your Photos",multiple:!0,library:{type:"image",uploadedTo:c.wsuwp_people_edit_profile.post_id},button:{text:"Use photo(s)"}})).on("select",function(){var e=t.state().get("selection");u.each(e.models,function(e,t){var o=t.toJSON(),a=o.sizes.hasOwnProperty("thumbnail")?o.sizes.thumbnail.url:o.url,s=!1;-1===u.inArray(o.id,f.existing_photos())?(u("button.wsu-person-add-photo").before(d({src:a,id:o.id})),!s&&u(".photo").hasClass("wsu-person-add-photo")&&(u(".photo").removeClass("wsu-person-add-photo").prepend("<img src='"+a+"'>"),u(".photo figcaption").text("Manage photo collection"),s=!0)):c.alert(o.url+" is already in your collection.")})}),t.open()}),l.on("click",".wsu-person-remove",function(){u(this).parent(".wsu-person-photo-wrapper").remove()}),l.sortable({cursor:"move",placeholder:"wsu-person-photo-wrapper placeholder",items:"> .wsu-person-photo-wrapper",start:function(e,t){t.helper.height("").width("")}}),f.close_photo_collection=function(){var e=u(".photo img"),t=u(".wsu-person-photo-wrapper:first-of-type img");t.length?e.attr("src",t.attr("src")):(e.remove(),u(".photo").addClass("wsu-person-add-photo").find("figcaption").text("+ Add photo(s)")),u("body").removeClass("wsu-person-photo-collection-open"),o.focus()}}),f.existing_photos=function(){return u("[name='_wsuwp_profile_photos[]']").map(function(){return parseInt(u(this).val())}).get()},u(".legacy-meta-delete").click(function(){var e=u(this).data("name"),t=u(this).data("metakey"),o=u(this).closest(".wsu-person-bio");c.confirm("This will permanently delete your "+e+" data.");var a={action:"wsu_people_delete_legacy_meta",_ajax_nonce:c.wsuwp_people_edit_profile.nid_nonce,post_id:u("#post_ID").val(),meta_key:t};u.post(c.ajaxurl,a,function(e){e.success&&o.fadeOut(300,function(){u(this).remove()})})})}(jQuery,window,document,wsuwp);