var wsuwp=wsuwp||{};!function(e,t,o,a){e(o).ready(function(){var s,n,i=e("#load-ad-data"),r=e("#publishing-action .spinner"),l=e("#_wsuwp_profile_ad_nid"),p=e("#confirm-ad-hash"),d=e("#confirm-ad-data"),u=e(".wsu-person .card"),c=e(".wsu-person-photo-collection"),h=_.template(e(".wsu-person-repeatable-meta-template").html()),f=_.template(e(".wsu-person-photo-template").html());e(".card header").append("<button type='button' data-type='degree' class='wsu-person-add-repeatable-meta wsu-person-add-degree'>+ Add</button>"),e(".contact .title").last().after("\n<button type='button' data-type='title' class='wsu-person-add-repeatable-meta wsu-person-add-title'>+ Add another title</button>"),e.each(e(".contact .title").slice(1),function(){e(this).after("<button type='button' class='wsu-person-remove dashicons dashicons-no'><span class='screen-reader-text'>Delete</span></button>")}),e.each(e("header .degree"),function(){e(this).after("<button type='button' class='wsu-person-remove dashicons dashicons-no'><span class='screen-reader-text'>Delete</span></button>")}),i.on("click",function(o){if(o.preventDefault(),o.target.disabled=!0,""!==l.val()){r.css("visibility","visible");var s={action:"wsu_people_get_data_by_nid",_ajax_nonce:t.wsuwp_people_edit_profile.nid_nonce,network_id:l.val(),request_from:t.wsuwp_people_edit_profile.request_from};e.post(t.ajaxurl,s,function(s){o.target.disabled=!1,r.css("visibility","hidden"),s.success?e.isEmptyObject(s.data)?t.alert("Sorry, a profile for "+l.val()+" could not be found."):(s.data.id?a.people.populate_person_from_people_directory(s.data):(e(".wsu-person").attr("data-nid",l.val()),e(".wsu-person .name").text(s.data.given_name+" "+s.data.surname),e("[name='post_title']").val(s.data.given_name+" "+s.data.surname),e(".wsu-person .title").text(s.data.title),e("[name='_wsuwp_profile_title[]']").val(s.data.title),e(".wsu-person .email").text(s.data.email),e("[name='_wsuwp_profile_alt_email']").val(s.data.email),e(".wsu-person .phone").text(s.data.telephone_number),e("[name='_wsuwp_profile_alt_phone']").val(s.data.telephone_number),e(".wsu-person .office").text(s.data.office),e("[name='_wsuwp_profile_alt_office']").val(s.data.office),e(".wsu-person .address").text(s.data.street_address),e("[name='_wsuwp_profile_alt_address']").val(s.data.street_address),p.val(s.data.confirm_ad_hash)),e("#wsuwp-university-taxonomies").addClass("show"),e("#wsuwp-profile-listing").addClass("show"),e("#wsuwp-profile-local-display").addClass("show"),d.removeClass("profile-hide-button")):t.alert(s.data)})}else t.alert("Please enter a Network ID")}),d.on("click",function(o){o.preventDefault(),o.target.disabled=!0,r.css("visibility","visible"),e("#load-ad-data").addClass("profile-hide-button");var a={action:"wsu_people_confirm_nid_data",_ajax_nonce:t.wsuwp_people_edit_profile.nid_nonce,network_id:l.val(),confirm_ad_hash:p.val(),post_id:e("#post_ID").val(),request_from:t.wsuwp_people_edit_profile.request_from},s=e(".load-ad-container .description"),n=e("#publish");e.post(t.ajaxurl,a,function(t){t.success&&(l.attr("readonly",!0),s.html("The WSU Network ID used to populate this profile's data from "+s.data("location")+"."),e(".spinner").css("visibility","hidden"),d.addClass("profile-hide-button"),n.removeClass("profile-hide-button"))})}),u.on("focusout","[contenteditable='true']",function(){var t=e(this).attr("class"),o=e(this).index("."+t),a=e(this).text();e("[data-for='"+t+"']").eq(o).val(a)}),u.on("keypress","[contenteditable='true']",function(e){13===e.which&&e.preventDefault()}),u.on("click",".wsu-person-add-repeatable-meta",function(){e(this).before(h({type:e(this).data("type"),value:""}))}),u.on("focus",".title, .degree",function(){e(this).next("button:not(.wsu-person-add-repeatable-meta)").show(50)}),u.on("focusout",".title, .degree, .wsu-person-remove",function(t){var o=e(t.relatedTarget);if(!o.hasClass("wsu-person-remove"))if(o.hasClass("title")||o.hasClass("title")){var a=o.next(".wsu-person-remove").index(".wsu-person-remove");e(".wsu-person-remove").not(":eq("+a+")").hide(50)}else e(".wsu-person-remove").hide(50)}),u.on("click",".wsu-person-remove",function(){var t=e(this).prev("span"),o=t.attr("class"),a=t.index("."+o);t.remove(),e("[data-for='"+o+"']").eq(a).remove(),e(this).remove()}),u.on("click",".photo",function(){if(!e(this).hasClass("wsu-person-add-photo")){var a=e(this).offset();s=o.activeElement,e(t).scrollTop(0),e("body").addClass("wsu-person-photo-collection-open"),c.css({top:a.top,left:a.left}),e(".wsu-person-add-photo").focus()}}),e(o).keydown(function(t){if(e("body").hasClass("wsu-person-photo-collection-open")){if(9===t.which){var o=c.find("button"),s=o.index(e(":focus"));t.shiftKey&&0===s?(o[o.length-1].focus(),t.preventDefault()):event.shiftKey||s!==o.length-1||(o[0].focus(),t.preventDefault())}27===t.which&&a.close_photo_collection()}}),e(o).on("click",".wsu-person-photo-collection-close",function(e){e.target===this&&a.close_photo_collection()}),e(o).on("click",".wsu-person-add-photo",function(){n?n.open():((n=t.wp.media({title:"Select or Upload Your Photos",multiple:!0,library:{type:"image",uploadedTo:t.wsuwp_people_edit_profile.post_id},button:{text:"Use photo(s)"}})).on("select",function(){var o=n.state().get("selection");e.each(o.models,function(o,s){var n=s.toJSON(),i=n.sizes.hasOwnProperty("thumbnail")?n.sizes.thumbnail.url:n.url,r=!1;-1===e.inArray(n.id,a.existing_photos())?(e("button.wsu-person-add-photo").before(f({src:i,id:n.id})),!r&&e(".photo").hasClass("wsu-person-add-photo")&&(e(".photo").removeClass("wsu-person-add-photo").prepend("<img src='"+i+"'>"),e(".photo figcaption").text("Manage photo collection"),r=!0)):t.alert(n.url+" is already in your collection.")})}),n.open())}),c.on("click",".wsu-person-remove",function(){e(this).parent(".wsu-person-photo-wrapper").remove()}),c.sortable({cursor:"move",placeholder:"wsu-person-photo-wrapper placeholder",items:"> .wsu-person-photo-wrapper",start:function(e,t){t.helper.height("").width("")}}),a.close_photo_collection=function(){var t=e(".photo img"),o=e(".wsu-person-photo-wrapper:first-of-type img");o.length?t.attr("src",o.attr("src")):(t.remove(),e(".photo").addClass("wsu-person-add-photo").find("figcaption").text("+ Add photo(s)")),e("body").removeClass("wsu-person-photo-collection-open"),s.focus()}}),a.existing_photos=function(){return e("[name='_wsuwp_profile_photos[]']").map(function(){return parseInt(e(this).val())}).get()},e(".legacy-meta-delete").click(function(){var o=e(this).data("name"),a=e(this).data("metakey"),s=e(this).closest(".wsu-person-bio");t.confirm("This will permanently delete your "+o+" data.");var n={action:"wsu_people_delete_legacy_meta",_ajax_nonce:t.wsuwp_people_edit_profile.nid_nonce,post_id:e("#post_ID").val(),meta_key:a};e.post(t.ajaxurl,n,function(t){t.success&&s.fadeOut(300,function(){e(this).remove()})})})}(jQuery,window,document,wsuwp);