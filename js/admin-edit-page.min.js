!function(d,u,e){var t=d("#page_template"),o=d("#wsuwp-people-directory-configuration"),s=d("#postdivrich"),i=d("#directory-page-profile-ids"),n=d(".wsu-people-directory-options-header"),a=d("#wsu-people-import-organization"),p=d("#wsu-people-import-location"),r=d("#wsu-people-import-wsu-category"),c=d("#wsu-people-import-classification"),h=d("#wsu-people-import-category"),f=d("#wsu-people-import-tag"),l=d("#wsu-people-directory-layout"),w=d("#wsu-people-directory-show-photos"),m=d("#wsu-people-directory-about"),g=d("#wsu-people-directory-link"),v=d(".toggle-select-mode"),b=d(".select-all-people"),y=d(".delete-selected-people"),k=d(".wsu-people-wrapper"),C=d(".wsu-people"),x=d(".person-modal"),j=d(".wsu-person-controls-tooltip"),S=_.template(d("#wsu-person-template").html()),A=[],R=[];function D(){d(".has-photo .photo img").each(function(){d(this).attr("src",d(this).data("photo"))})}function B(e,t,o,s){d.ajax({url:u.wsuwp_people_edit_page.rest_url,data:e}).done(function(e){t=e.reduceRight(function(e,t){return e.unshift(t),e},t),o===s&&H(t)})}function H(e){C.find(".spinner").remove(),e.sort(I),U(e),D(),W(),d(".wsu-people-directory-options.add").removeClass("open").children("div").hide(),d(".wsu-people-directory-options, .wsu-people-bulk-actions").slideDown()}function I(e,t){return e.last_name<t.last_name?-1:e.last_name>t.last_name?1:0}function U(e){d.each(e,function(e,t){""!==t.nid&&-1===d.inArray(t.id,R)&&-1===d.inArray(t.nid,A)&&(i.val(function(){return this.value+" "+t.id}),C.append(S({nid:t.nid,id:t.id,has_photo:t.photos&&0<t.photos.length?" has-photo":"",slug:t.slug,name:t.title.rendered,photo:t.photos&&0<t.photos.length?t.photos[0].thumbnail:"",title:0<t.working_titles.length?t.working_titles[0]:t.position_title,email:t.email_alt?t.email_alt:t.email,phone:t.phone_alt?t.phone_alt:t.phone+t.phone_ext,office:t.office_alt?t.office_alt:t.office,address:t.address,website:t.website,content:t.content.rendered})),A.push(t.nid),R.push(t.id))})}function W(){var e=C.find(".wsu-person").map(function(){return d(this).data("profile-id")}).get();i.val(e.join(" "))}d(e).ready(function(){function e(o){return{delay:500,minLength:3,source:function(e,t){d.ajax({url:u.wsuwp_people_edit_page.rest_route+o,data:{search:e.term,per_page:50},success:function(e){t(d.map(e,function(e){return{label:e.name,value:e.slug}}))}})}}}D(),t.on("change",function(){"templates/people.php"===d(this).val()?(o.show(),s.hide()):(o.hide(),"template-builder.php"!==d(this).val()&&s.show())}),a.autocomplete(e("organization")),p.autocomplete(e("location")),r.autocomplete(e("university_category")),c.autocomplete(e("classification")),h.autocomplete(e("categories")),f.autocomplete(e("tags")),d("#wsu-people-import").on("click",function(){var l={per_page:100};""!==a.val()&&(l["filter[wsuwp_university_org]"]=a.val()),""!==p.val()&&(l["filter[wsuwp_university_location]"]=p.val()),""!==r.val()&&(l["filter[wsuwp_university_category]"]=r.val()),""!==c.val()&&(l["filter[classification]"]=c.val()),""!==h.val()&&(l["filter[taxonomy]"]="category",l["filter[term]"]=h.val()),""!==f.val()&&(l["filter[tag]"]=f.val()),C.html("<span class='spinner'></span>"),d.ajax({url:u.wsuwp_people_edit_page.rest_url,data:l}).done(function(e,t,o){var s=parseInt(o.getResponseHeader("x-wp-totalpages"));if(1===s)H(e);else if(1<s)for(var i=e,n=1;n<s;)n++,l.page=n,B(l,i,n,s)})}),n.on("click",function(){var e=d(this).closest(".wsu-people-directory-options"),t=e.children("div");e.hasClass("open")?(e.removeClass("open"),t.slideUp()):(e.addClass("open"),t.slideDown())}),l.on("change",function(){var e=d(this).val();l.find("option").not(":selected").each(function(){k.removeClass(d(this).val())}),k.addClass(e)}),w.on("change",function(){"yes"===d(this).val()?k.addClass("photos"):k.removeClass("photos")}),m.on("change",function(){var o=d(this).val();C.find(".wsu-person").each(function(){var e=d(this).find("div[data-key='"+o+"']"),t=d(this).find(".about");"none"!==o&&e.length?t.html(e.find(".content").html()):t.html("")})}),g.on("change",function(){var t=d(this).val();C.find(".wsu-person").each(function(){var e=d(this).find("div[data-key='personal']");"no"===t||"if_bio"===t&&!e.length?d(this).addClass("no-link").removeClass("link"):d(this).removeClass("no-link").addClass("link")})}),C.sortable({cursor:"move",start:function(e,t){t.placeholder.height(t.item.height())},stop:function(){W()}}),v.on("click",function(){"Bulk Select"===d(this).text()?(d(this).text("Cancel Selection"),b.show(),y.show().prop("disabled",!0),k.addClass("bulk-select"),C.sortable("option","disabled",!0)):(d(this).text("Bulk Select"),b.hide(),y.hide().prop("disabled",!0),k.removeClass("bulk-select"),C.find(".wsu-person").removeClass("selected").attr("aria-checked","false"),C.sortable("option","disabled",!1))}),b.on("click",function(){"Select All"===d(this).text()?(d(this).text("Deselect All"),C.find(".wsu-person").addClass("selected").attr("aria-checked","true"),y.prop("disabled",!1)):(d(this).text("Select All"),C.find(".wsu-person").removeClass("selected").attr("aria-checked","false"),y.prop("disabled",!0))}),C.on("click",".wsu-person",function(){k.is(".bulk-select")&&(d(this).toggleClass("selected"),d(this).hasClass("selected")?d(this).attr("aria-checked","true"):d(this).attr("aria-checked","false"),0<C.find(".selected").length?y.prop("disabled",!1):(b.text("Select All"),y.prop("disabled",!0)),C.find(".wsu-person").length===C.find(".selected").length&&b.text("Deselect All"))}),y.on("click",function(){C.find(".selected").remove(),W()}),C.on("mouseover",".wsu-person-controls button",function(){var e=this.getAttribute("aria-label"),t=this.getBoundingClientRect(),o=C[0].getBoundingClientRect();j.find(".wsu-person-controls-tooltip-inner").html(e),j.css({top:t.bottom-o.top+"px",left:t.right-o.left-j.width()/2-t.width/2+"px"}).show()}),C.on("mouseleave",".wsu-person-controls button",function(){j.hide()}),C.on("click",".wsu-person-edit",function(){d(this).closest(".wsu-person").find(".person-modal-wrapper").addClass("active"),d("body").addClass("person-modal-open"),C.sortable("option","disabled",!0)}),C.on("click",".wsu-person-remove",function(){d(this).closest(".wsu-person").remove(),W()}),C.on("click",".close",function(e){e.target===this&&(d(this).closest(".person-modal-wrapper").removeClass("active"),d("body").removeClass("person-modal-open"),C.sortable("option","disabled",!1))}),x.on("click",".choose > div",function(){d(this).toggleClass("selected"),d(this).closest(".choose").hasClass("multiple")||d(this).siblings().removeClass("selected")}),x.on("click",".person-update",function(){var e,t,o=d(this).closest(".wsu-person"),s=d(this).closest(".person-modal-wrapper"),i={action:"person_details",nonce:u.wsuwp_people_edit_page.nonce,page:u.wsuwp_people_edit_page.page_id,post:o.data("post-id")};if(s.find(".person-photos .selected")){var n=s.find(".person-photos .selected");i.photo=n.data("index"),o.find(".photo img").attr("src",n.find("img").attr("src"))}if(s.find(".person-titles .selected")){var l="",a=[],p=s.find(".person-titles .selected .content"),r=p.length;p.each(function(e){a.push(d(this).closest(".selected").data("index")),l+=d(this).html(),e!==r-1&&(l+="<br />")}),i.title=a.join(" "),o.find(".card .title").html(l)}if(s.find(".person-content .selected")){var c=s.find(".person-content .selected");i.about=c.data("key"),o.find(".about").html(c.find(".content").html())}e=i,t=s,d.post(u.wsuwp_people_edit_page.ajax_url,e).done(function(){t.removeClass("active"),C.sortable("option","disabled",!1),d("body").removeClass("person-modal-open")})})}),d(".wsu-people-admin-wrapper").hasClass("loading")&&(C.prepend("<p class='description importing-profiles'>Importing profiles, please wait.<span class='spinner'></span><p>"),function t(){d.ajax({url:u.wsuwp_people_edit_page.ajax_url,data:{action:"check_inserted_profiles",nonce:u.wsuwp_people_edit_page.nonce,page:u.wsuwp_people_edit_page.page_id}}).done(function(e){"false"===e?setTimeout(t,6e3):(d(".wsu-people-admin-wrapper").removeClass("loading"),d(".importing-profiles").remove(),U(JSON.parse(e)),D())})}()),d("#publish").click(function(){d.ajax({url:u.wsupeoplesync.endpoint,method:"GET",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",u.wsupeoplesync.nonce),e.setRequestHeader("X-WSUWP-UID",u.wsupeoplesync.uid)},data:{site_url:u.wsupeoplesync.site_url,ids:d("#directory-page-profile-ids").val().split(" ")}})})}(jQuery,window,document);